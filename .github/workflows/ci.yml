name: CI

on:
  - push
  - pull_request
  - workflow_dispatch

jobs:
  ci-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install -e ".[dev]"
    
    - name: Run Linters
      run: |
        python -m pip install ruff mypy
        ruff check src/pywellen_mcp/ || true
        mypy src/pywellen_mcp/ --ignore-missing-imports || true
    
    - name: Run Unit Tests
      run: |
        pytest tests/unit/ -v --cov=pywellen_mcp --cov-report=xml --cov-report=term
    
    - name: Upload Coverage
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-pywellen-mcp
    
    - name: Build Package
      if: matrix.python-version == '3.11'
      run: |
        python -m pip install build
        # Update version with build number for development releases
        if [[ ! "${{ github.ref }}" =~ ^refs/tags/v ]]; then
          sed -i -e "s/version = \"\([0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\)\"/version = \"\1.dev${GITHUB_RUN_ID}\"/g" pyproject.toml
        fi
        python -m build .
    
    - name: Build Documentation
      if: matrix.python-version == '3.11'
      run: |
        python -m pip install -e ".[docs]"
        cd docs && make html
        touch _build/html/.nojekyll
    
    - name: Upload Package Artifacts
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: python-package
        path: dist/
    
    - name: Upload Documentation Artifacts
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html/
    
    - name: Publish to PyPI
      if: matrix.python-version == '3.11' && startsWith(github.ref, 'refs/tags/v')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
    
    - name: Publish Documentation
      if: matrix.python-version == '3.11' && github.ref == 'refs/heads/main'
      uses: JamesIves/github-pages-deploy-action@v4.4.1
      with:
        branch: gh-pages
        folder: docs/_build/html

  ci-integration:
    runs-on: ubuntu-latest
    needs: ci-linux
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -e ".[dev]"
    
    - name: Download Test Waveforms
      run: |
        # Download sample VCD files for integration testing
        mkdir -p tests/fixtures
        # Note: Add URLs to real test waveforms when available
        echo "Integration test waveforms would be downloaded here"
    
    - name: Run Integration Tests
      run: |
        # Run integration tests when available
        # pytest tests/integration/ -v
        echo "Integration tests would run here"
    
    - name: Performance Benchmarks
      run: |
        # Run performance benchmarks
        # python scripts/benchmark.py
        echo "Performance benchmarks would run here"

  ci-security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -e ".[dev]"
    
    - name: Security Scan
      run: |
        python -m pip install bandit safety
        bandit -r src/pywellen_mcp/ -ll || true
        safety check || true
    
    - name: Dependency Audit
      run: |
        python -m pip list --format=json | \
          python -c "import sys,json; [print(p['name']+'=='+p['version']) for p in json.load(sys.stdin)]"
